<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Daily Tracker</title>
  <style>
    :root{
      --bg:#0b2447; /* dark blue */
      --accent:#0f4c81;
      --white:#ffffff;
      --muted:rgba(255,255,255,0.8);
      --card-bg:rgba(255,255,255,0.03);
      --glass:rgba(255,255,255,0.04);
    }
    html,body{height:100%;}
    body{
      margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:var(--bg);color:var(--white);
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .app{max-width:1100px;margin:24px auto;padding:20px;}
    header{display:flex;align-items:center;gap:20px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    nav{display:flex;gap:8px}
    .tab{padding:8px 12px;border-radius:8px;cursor:pointer;background:transparent;border:1px solid transparent}
    .tab.active{background:var(--glass);border-color:rgba(255,255,255,0.06)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .card{background:var(--card-bg);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .small{font-size:13px;color:var(--muted)}

    /* To-do list */
    .todo-list{display:flex;flex-direction:column;gap:8px}
    .task{display:flex;align-items:flex-start;gap:10px;padding:8px;border-radius:8px}
    .task .label{flex:1}
    .task.completed .label{text-decoration:line-through;opacity:0.6}
    .subtask{padding-left:26px}
    .controls{display:flex;gap:8px}
    input[type=text]{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:var(--white)}
    button{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;color:var(--white);cursor:pointer}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}

    /* stats */
    .stats{display:flex;gap:12px;margin-top:12px}
    .stat{flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);text-align:center}

    /* activity lists */
    .record-row{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .totals{display:flex;gap:12px;align-items:center}
    table{width:100%;border-collapse:collapse}
    .muted{color:var(--muted)}
    footer{margin-top:20px;font-size:12px;color:var(--muted)}

    /* responsive */
    @media(max-width:980px){.grid{grid-template-columns:1fr;}.app{padding:12px}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Daily Tracker</h1>
      <nav>
        <div class="tab active" data-tab="home">Home</div>
        <div class="tab" data-tab="daily">Daily</div>
        <div class="tab" data-tab="activity">Activity</div>
      </nav>
    </header>

    <main>
      <section id="home" class="view">
        <div class="grid">
          <div>
            <div class="card">
              <h3>Today's Quick To‑Do</h3>
              <div id="home-tasks" class="todo-list small"></div>
              <div class="stats" style="margin-top:10px">
                <div class="stat"><div class="small muted">7‑day avg complete</div><div id="seven-day-avg">—</div></div>
                <div class="stat"><div class="small muted">Today's complete</div><div id="today-complete">—</div></div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Enter weight / body fat</h3>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="weight-input" type="text" placeholder="weight (lbs)">
                <input id="bf-input" type="text" placeholder="body fat %">
                <button id="save-weight">Save</button>
              </div>
              <div style="margin-top:8px"><small class="muted">Recent</small>
                <div id="recent-weight-list"></div>
              </div>
            </div>
          </div>

          <aside>
            <div class="card">
              <h3>Today Macros</h3>
              <div class="totals small" style="justify-content:space-between">
                <div>Calories: <strong id="macro-cals">0</strong></div>
                <div>Protein: <strong id="macro-prot">0</strong></div>
              </div>
              <div style="margin-top:8px">
                <input type="text" id="food-item" placeholder="food item">
                <input type="text" id="food-cals" placeholder="cals" style="width:80px">
                <input type="text" id="food-prot" placeholder="protein" style="width:80px">
                <button id="add-food">Add</button>
              </div>
              <div id="food-list" style="margin-top:8px" class="small"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Quick Activity</h3>
              <div class="small muted">Add run/bench/fitness times in Activity tab for full history & graphs.</div>
            </div>
          </aside>
        </div>
      </section>

      <section id="daily" class="view" style="display:none">
        <div class="card">
          <h3>Daily To‑Do</h3>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="new-task" type="text" placeholder="New task name">
            <button id="add-task">Add</button>
            <button id="reset-tasks" class="ghost">Reset to default</button>
          </div>
          <div id="task-list" class="todo-list" style="margin-top:8px"></div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>7‑day Completion</h3>
          <div id="seven-day-list" class="small"></div>
        </div>
      </section>

      <section id="activity" class="view" style="display:none">
        <div class="grid" style="grid-template-columns:1fr 420px;gap:12px">
          <div>
            <div class="card">
              <h3>Performance Tests</h3>
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
                <select id="perf-type"><option value="3mile">3 Mile Run (time in mm:ss)</option><option value="10k">10k Run (mm:ss)</option><option value="bench">Bench Press (lbs)</option><option value="fitness">Fitness Test (score)</option></select>
                <input id="perf-date" type="date">
                <input id="perf-value" type="text" placeholder="time or value">
                <button id="add-perf">Add</button>
              </div>
              <div id="perf-list" style="margin-top:10px" class="small"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Weight & Bodyfat</h3>
              <div style="display:flex;gap:8px;margin-top:8px">
                <input id="wb-date" type="date">
                <input id="wb-weight" type="text" placeholder="weight">
                <input id="wb-bf" type="text" placeholder="body fat %">
                <button id="add-wb">Add</button>
              </div>
              <div id="wb-list" style="margin-top:8px" class="small"></div>
            </div>

          </div>

          <aside>
            <div class="card">
              <h3>Graphs</h3>
              <canvas id="perf-chart" width="400" height="240"></canvas>
              <div style="height:12px"></div>
              <canvas id="wb-chart" width="400" height="200"></canvas>
            </div>
          </aside>
        </div>
      </section>
    </main>

    <footer class="small muted">Local browser storage used. Data stays in your browser. Use export/import below.</footer>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="webapp-url" type="text" placeholder="Paste Apps Script Web App URL here" style="width:420px" value="https://script.google.com/macros/s/AKfycbw-dcaX5vKeyMjc7dbPDamQkMsPEiJwBYxqRY7MMWBOhTGti0q_2iV1vrdQ_76wvPsR/exec">
      <button id="sync-save">Sync → Drive</button>
      <button id="sync-load" class="ghost">Load ← Drive</button>
      <button id="export">Export JSON</button>
      <button id="import" class="ghost">Import JSON</button>
      <input id="import-file" type="file" style="display:none">
    </div>
  </div>

  <script>
    // --- Utilities & storage ---
    const STORAGE_KEY = 'dailyTracker_v1';
    const defaultTasks = [
      {id:genId(),title:'Vitamin D',sub:[]},
      {id:genId(),title:'Wellbutrin',sub:[]},
      {id:genId(),title:'Morning IMRTQA',sub:[]},
      {id:genId(),title:'Next Day New Starts',sub:[]},
      {id:genId(),title:'Morning Chart Checks',sub:[]},
      {id:genId(),title:'Afternoon Chart Checks',sub:[]},
      {id:genId(),title:'Final Work Checks',sub:[]},
      {id:genId(),title:'ABR Flash Cards',sub:[]},
      {id:genId(),title:'Workout',sub:[]}
    ];

    function genId(){return 't'+Math.random().toString(36).slice(2,9)}

    function load(){
      try{const raw = localStorage.getItem(STORAGE_KEY); if(raw) return JSON.parse(raw);}catch(e){}
      return {tasks:defaultTasks, completions:{}, perf:[], wb:[], food:[]};
    }
    function save(state){localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}

    let state = load();

    // --- Tab control ---
    document.querySelectorAll('.tab').forEach(el=>el.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
      document.querySelectorAll('.view').forEach(v=>v.style.display='none');
      document.getElementById(el.dataset.tab).style.display='block';
      renderAll();
    }));

    // --- Tasks rendering & interactions ---
    const taskListEl = document.getElementById('task-list');
    const homeTasksEl = document.getElementById('home-tasks');
    const sevenDayAvgEl = document.getElementById('seven-day-avg');
    const sevenDayListEl = document.getElementById('seven-day-list');

    function todayKey(d=new Date()){return d.toISOString().slice(0,10)}

    function renderAll(){renderTasks();renderHomeTasks();renderSevenDay();renderFood();renderWBList();renderPerfList();drawCharts();renderRecentWeights();}

    function renderTasks(){
      taskListEl.innerHTML='';
      state.tasks.forEach(t=>{
        const row = taskRow(t,false);
        taskListEl.appendChild(row);
        if(t.sub && t.sub.length){ t.sub.forEach(s=>taskListEl.appendChild(taskRow(s,true,t.id))); }
      });
    }

    function taskRow(task,isSub,parentId){
      const div = document.createElement('div');div.className='task'+(isSub?' subtask':'');
      const chk = document.createElement('input');chk.type='checkbox';
      const label = document.createElement('div');label.className='label';label.textContent = task.title;
      const right = document.createElement('div');right.className='controls';
      const addSub = document.createElement('button');addSub.textContent='+sub';addSub.className='ghost';
      const del = document.createElement('button');del.textContent='del';del.className='ghost';

      // set checked based on today's completions
      const date= todayKey();
      const comp = state.completions[date]||{};
      chk.checked = !!comp[task.id];
      if(chk.checked) div.classList.add('completed');

      chk.addEventListener('change',()=>{
        state.completions[date] = state.completions[date]||{};
        if(chk.checked){ state.completions[date][task.id]=true; div.classList.add('completed'); }
        else { delete state.completions[date][task.id]; div.classList.remove('completed'); }
        save(state); renderHomeTasks(); renderSevenDay();
      });

      addSub.addEventListener('click',()=>{
        const name = prompt('Subtask name'); if(!name) return;
        const sub = {id:genId(),title:name,sub:[]};
        // find parent and add
        const p = state.tasks.find(x=>x.id===task.id) || state.tasks.find(x=>x.id===parentId);
        if(p){ p.sub = p.sub || []; p.sub.push(sub); save(state); renderAll(); }
      });

      del.addEventListener('click',()=>{
        if(isSub){ // remove from parent
          state.tasks.forEach(t=>{if(t.sub) t.sub = t.sub.filter(s=>s.id!==task.id)});
        } else {
          state.tasks = state.tasks.filter(t=>t.id!==task.id);
        }
        // also remove completions across dates
        Object.keys(state.completions||{}).forEach(date=>{ if(state.completions[date][task.id]) delete state.completions[date][task.id]; });
        save(state); renderAll();
      });

      right.appendChild(addSub); right.appendChild(del);
      div.appendChild(chk); div.appendChild(label); div.appendChild(right);
      return div;
    }

    document.getElementById('add-task').addEventListener('click',()=>{
      const v = document.getElementById('new-task').value.trim(); if(!v) return; state.tasks.push({id:genId(),title:v,sub:[]}); document.getElementById('new-task').value=''; save(state); renderAll();
    });

    document.getElementById('reset-tasks').addEventListener('click',()=>{ if(confirm('Reset tasks to default?')){ state.tasks = JSON.parse(JSON.stringify(defaultTasks)); save(state); renderAll(); }});

    // --- Home mini list & stats ---
    function renderHomeTasks(){
      homeTasksEl.innerHTML='';
      const todays = state.tasks;
      const date = todayKey();
      const comp = state.completions[date]||{};
      let done = 0, total=0;
      todays.forEach(t=>{
        total++; const d = document.createElement('div'); d.className='task';
        const chk = document.createElement('input'); chk.type='checkbox'; chk.checked=!!comp[t.id]; chk.addEventListener('change',()=>{
          // toggle in main state
          state.completions[date]=state.completions[date]||{};
          if(chk.checked) state.completions[date][t.id]=true; else delete state.completions[date][t.id]; save(state); renderAll();
        });
        const l = document.createElement('div'); l.className='label'; l.textContent = t.title;
        d.appendChild(chk); d.appendChild(l); homeTasksEl.appendChild(d);
        if(comp[t.id]) done++;
        if(t.sub) t.sub.forEach(s=>{ total++; const sd = document.createElement('div'); sd.className='task subtask'; const sck=document.createElement('input'); sck.type='checkbox'; sck.checked=!!comp[s.id]; sck.addEventListener('change',()=>{ state.completions[date]=state.completions[date]||{}; if(sck.checked) state.completions[date][s.id]=true; else delete state.completions[date][s.id]; save(state); renderAll(); }); const sl=document.createElement('div');sl.className='label';sl.textContent=s.title; sd.appendChild(sck); sd.appendChild(sl); homeTasksEl.appendChild(sd); if(comp[s.id]) done++; });
      });
      document.getElementById('today-complete').textContent = total? Math.round((done/total)*100)+'%':'—';
    }

    function renderSevenDay(){
      const arr=[]; const today = new Date();
      for(let i=6;i>=0;i--){ const d = new Date(today); d.setDate(today.getDate()-i); const k = d.toISOString().slice(0,10); const comp = state.completions[k]||{}; // total tasks on that day equals number of tasks present at that day (assume current tasks)
        let total=0,done=0; state.tasks.forEach(t=>{ total++; if(comp[t.id]) done++; if(t.sub) t.sub.forEach(s=>{ total++; if(comp[s.id]) done++; }); });
        const pct = total? Math.round((done/total)*100):0; arr.push({date:k,pct});
      }
      // show list
      sevenDayListEl.innerHTML = arr.map(a=>`<div>${a.date}: ${a.pct}%</div>`).join('');
      const avg = Math.round(arr.reduce((s,x)=>s+x.pct,0)/arr.length);
      sevenDayAvgEl.textContent = isNaN(avg)?'—':avg+'%';
    }

    // --- Food / macros ---
    function renderFood(){
      const today = todayKey(); const foods = (state.food||[]).filter(f=>f.date===today);
      const listEl = document.getElementById('food-list'); listEl.innerHTML=''; let cals=0,prot=0;
      foods.forEach(f=>{ cals+=Number(f.cals||0); prot+=Number(f.prot||0); const div=document.createElement('div'); div.textContent = `${f.item} — ${f.cals} cals / ${f.prot} g`; listEl.appendChild(div); });
      document.getElementById('macro-cals').textContent = cals; document.getElementById('macro-prot').textContent = prot;
    }
    document.getElementById('add-food').addEventListener('click',()=>{
      const item = document.getElementById('food-item').value.trim(); const c = Number(document.getElementById('food-cals').value||0); const p = Number(document.getElementById('food-prot').value||0); if(!item) return; state.food = state.food||[]; state.food.push({id:genId(),date:todayKey(),item, cals:c, prot:p}); document.getElementById('food-item').value=''; document.getElementById('food-cals').value=''; document.getElementById('food-prot').value=''; save(state); renderFood(); });

    // --- Performance data ---
    function renderPerfList(){
      const el = document.getElementById('perf-list'); el.innerHTML=''; (state.perf||[]).slice().reverse().forEach(p=>{ const d=document.createElement('div'); d.className='record-row'; d.innerHTML = `<div>${p.type} — ${p.date}</div><div>${p.val}</div>`; el.appendChild(d); });
    }
    document.getElementById('add-perf').addEventListener('click',()=>{
      const type=document.getElementById('perf-type').value; const date=document.getElementById('perf-date').value||todayKey(); const val=document.getElementById('perf-value').value.trim(); if(!val) return; state.perf=state.perf||[]; state.perf.push({id:genId(),type,date,val}); save(state); renderPerfList(); drawCharts(); });

    // --- Weight & bodyfat ---
    function renderWBList(){ const el=document.getElementById('wb-list'); el.innerHTML=''; (state.wb||[]).slice().reverse().forEach(w=>{ const d=document.createElement('div'); d.className='record-row'; d.innerHTML=`<div>${w.date}</div><div>${w.weight} lb / ${w.bf}%</div>`; el.appendChild(d); }); }
    document.getElementById('add-wb').addEventListener('click',()=>{ const date=document.getElementById('wb-date').value||todayKey(); const weight=document.getElementById('wb-weight').value.trim(); const bf=document.getElementById('wb-bf').value.trim(); if(!weight) return; state.wb=state.wb||[]; state.wb.push({id:genId(),date,weight:Number(weight),bf:Number(bf||0)}); save(state); renderWBList(); drawCharts(); renderRecentWeights(); });

    // save from home inputs
    document.getElementById('save-weight').addEventListener('click',()=>{ const w=document.getElementById('weight-input').value.trim(); const bf=document.getElementById('bf-input').value.trim(); if(!w) return; state.wb=state.wb||[]; state.wb.push({id:genId(),date:todayKey(),weight:Number(w),bf:Number(bf||0)}); save(state); renderWBList(); drawCharts(); renderRecentWeights(); document.getElementById('weight-input').value=''; document.getElementById('bf-input').value=''; });

    function renderRecentWeights(){ const el=document.getElementById('recent-weight-list'); el.innerHTML=''; (state.wb||[]).slice(-6).reverse().forEach(w=>{ const d=document.createElement('div'); d.className='small muted'; d.textContent=`${w.date}: ${w.weight} lb / ${w.bf}%`; el.appendChild(d); }); }

    // --- Charts (uses Chart.js if available) ---
    function drawCharts(){
      // prepare perf chart for selected metric types
      const perfCan = document.getElementById('perf-chart'); if(window.Chart){
        const perfData = state.perf||[];
        // group by type and plot up to 3 series
        const types = [...new Set(perfData.map(p=>p.type))].slice(0,3);
        const labels = [...new Set(perfData.map(p=>p.date))].sort();
        const datasets = types.map((t,i)=>({label:t, data: labels.map(ld=>{
          const found = perfData.find(p=>p.date===ld && p.type===t);
          if(!found) return null;
          const num = parseTimeOrNumber(found.val);
          return num;
        }), spanGaps:true}));
        if(window._perfChart) window._perfChart.destroy();
        window._perfChart = new Chart(perfCan.getContext('2d'),{type:'line',data:{labels, datasets}});
      }

      const wbCan = document.getElementById('wb-chart'); if(window.Chart){
        const arr = (state.wb||[]).slice().sort((a,b)=>a.date.localeCompare(b.date)); const labels = arr.map(x=>x.date);
        const wSeries = arr.map(x=>x.weight); const bfSeries = arr.map(x=>x.bf);
        if(window._wbChart) window._wbChart.destroy();
        window._wbChart = new Chart(wbCan.getContext('2d'),{type:'line',data:{labels, datasets:[{label:'weight',data:wSeries,spanGaps:true},{label:'bodyfat',data:bfSeries,spanGaps:true}]}, options:{scales:{y:{beginAtZero:false}}}});
      }
    }

    // helper - parse mm:ss to seconds or number
    function parseTimeOrNumber(s){ if(typeof s !== 'string') return Number(s);
      const m = s.match(/^(\d+):(\d{1,2})$/); if(m) return Number(m[1])*60+Number(m[2]); return Number(s);
    }

    // --- Export / Import ---
    document.getElementById('export').addEventListener('click',()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='daily-tracker-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    document.getElementById('import').addEventListener('click',()=>document.getElementById('import-file').click());
    document.getElementById('import-file').addEventListener('change',(ev)=>{
      const f = ev.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=e=>{ try{ state = JSON.parse(e.target.result); save(state); renderAll(); alert('Imported'); }catch(err){alert('Invalid file');}}; reader.readAsText(f);
    });

    // --- Google Apps Script sync helpers ---
    let WEBAPP_URL = ''; // optional: fill with deployed web app URL, or paste into input field

    function getWebAppUrl() {
      const input = document.getElementById('webapp-url');
      return (input && input.value && input.value.trim()) ? input.value.trim() : WEBAPP_URL;
    }

async function syncStateToDrive() {
  const url = getWebAppUrl();
  if (!url) return alert('Paste your Apps Script Web App URL first.');

  try {
    const body = new URLSearchParams();
    body.append('state', JSON.stringify(state));

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: body.toString()
    });

    const j = await res.json();
    if (j.status === 'ok') alert('Synced to Google Sheet.');
    else alert('Sync response: ' + JSON.stringify(j));

  } catch (err) {
    console.error(err);
    alert('Sync failed: ' + String(err));
  }
}

    async function loadStateFromDrive() {
      const url = getWebAppUrl();
      if (!url) return alert('Paste your Apps Script Web App URL into the input field first.');
      try {
        const res = await fetch(url);
        const j = await res.json();
        if (j.latest) {
          const parsed = JSON.parse(j.latest);
          state = parsed;
          save(state); // update localStorage
          renderAll();
          alert('Loaded latest state from Drive (timestamp: ' + (j.timestamp || 'unknown') + ')');
        } else {
          alert('No saved state found on Drive.');
        }
      } catch (err) {
        console.error(err);
        alert('Load failed: ' + String(err));
      }
    }

    // wire UI buttons
    document.getElementById('sync-save').addEventListener('click', syncStateToDrive);
    document.getElementById('sync-load').addEventListener('click', loadStateFromDrive);

    // optionally wrap save so callers can trigger sync if desired
    (function wrapSave(){
      const origSave = window.save;
      window.save = function(s){
        origSave(s);
        // do NOT auto-sync on every change unless you want writes to sheet frequently.
        // If you want auto-sync, uncomment the next line:
        // syncStateToDrive().catch(()=>{/* ignore */});
      };
    })();

    // --- simple export of current data for debugging on load"
    // load external Chart.js from CDN for charts if not present
    (function ensureChart(){ if(window.Chart) { renderAll(); return; } const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chart.js'; s.onload=()=>{ renderAll(); }; document.head.appendChild(s); })();

    // initial render
    renderAll();
  </script>
</body>
</html>
